<!doctype html>
if(btnGuide){
btnGuide.addEventListener('click',()=>{
const open = guide.classList.toggle('hidden');
btnGuide.setAttribute('aria-expanded', String(!open));
btnGuide.textContent = !open ? '시리즈 안내 접기' : '시리즈 안내 보기';
})
}


// -------- 년도 --------
document.getElementById('yy').textContent = new Date().getFullYear();


// ===== PDF 열기: 모바일/인앱 신뢰성 우선 로직 =====
function isMobile(){
const ua = navigator.userAgent.toLowerCase();
return /(iphone|ipad|ipod|android|windows phone|mobi)/i.test(ua);
}
function isInAppBrowser(){
const ua = navigator.userAgent.toLowerCase();
// 카카오/페북/인스타/네이버/라인 등 인앱 브라우저 식별
return /(kakaotalk|fbav|instagram|naver|line|daum)/i.test(ua);
}
function absoluteUrl(path){
if(!path) return '';
if(/^https?:\/\//i.test(path)) return path;
// 현재 페이지 기준 절대경로 생성
const base = location.origin + location.pathname.replace(/[^\/]*$/, '');
return new URL(path, base).toString();
}
function openViaGoogleViewer(filename){
const url = absoluteUrl(filename);
const g = 'https://docs.google.com/gview?embedded=1&url=' + encodeURIComponent(url);
// 인앱/모바일에서는 같은 탭으로 열어 신뢰도 향상
location.href = g;
}


// PDF.js 로컬 뷰어(권장). 루트 또는 /series/에 viewer.html 이 있다고 가정.
function getPdfJsUrl(filename){
const url = absoluteUrl(filename);
// 같은 리포 루트에 viewer.html 배치 권장 (없으면 Mozilla CDN으로 폴백)
const local = absoluteUrl('viewer.html') + '?file=' + encodeURIComponent(url);
const cdn = 'https://mozilla.github.io/pdf.js/web/viewer.html?file=' + encodeURIComponent(url);
return { local, cdn };
}


// 메인 오프너
function openPDF(filename, e){
if(e) e.preventDefault();
const fileUrl = absoluteUrl(filename);
const { local, cdn } = getPdfJsUrl(filename);


// 1) 인앱/모바일: 같은 탭 우선 (팝업차단 회피)
if(isMobile() || isInAppBrowser()){
// 먼저 로컬 viewer.html 시도 → 동작 실패/404 시 사용자가 뒤로가기로 복귀 가능
// onerror를 사용할 수 없으므로 일단 로컬로 열고, 문제가 있으면 사용자가 뒤로가서
// '다운로드' 버튼을 이용할 수 있도록 두며, 필요 시 아래 줄을 cdn으로 바꿀 수도 있음.
location.href = local;
// 만약 로컬 viewer.html 이 없다면, 사용자가 뒤로가기 했을 때 다시 누르면 구글뷰어가 열리도록
// 길게 누를 필요 없이 버튼 옆의 '다운로드'도 제공하고 있음.
return false;
}


// 2) 데스크톱: 새 탭 시도 → 차단 시 동일탭 전환 → 최종 Google Viewer
let win = window.open(local, '_blank', 'noopener');
const start = Date.now();
const fallback = () => {
try{
if(!win || win.closed){
// 새 탭이 차단된 경우 같은 탭으로 PDF.js CDN
location.href = cdn;
}
}catch(_){
// 보수적 폴백
openViaGoogleViewer(filename);
}
};
// 1.2초 안에 차단/에러 감지 시 폴백
setTimeout(()=>{
// 일부 브라우저는 즉시 null 반환하므로 시간차 확인
if(!win || win.closed || (Date.now()-start<200 && !win)){
fallback();
}
}, 1200);
return false;
}
// 전역 노출
window.openPDF = openPDF;
</script>
</body>
</html>
